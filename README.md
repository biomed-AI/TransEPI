# TransEPI: Capturing large genomic contexts for accurately predicting enhancer-promoter interactions

The codes and datasets for [Capturing large genomic contexts for accurately predicting enhancer-promoter interactions](https://www.biorxiv.org/content/10.1101/2021.09.04.458817v1).


TransEPI is a Transformer-based model for EPI prediction. 
This repository contains the scripts, data, and trained models for TransEPI.


![TransEPI](./figures/Figure1.svg)

# Requirements  

* numpy  
* tqdm  
* scikit-learn  
* PyTorch>=1.9.0 (recommended) or PyTorch 1.6.0+  
* pyBigWig (optional, required by `prepare_bw_signals.py` for preparing features)


# Datasets  

All the datasets used in this study are available at [data/BENGI](data/BENGI) and [data/HiC-loops](data/HiC-loops).  



# Quick start

1. Clone the codes: 
```
git clone git@github.com:biomed-AI/TransEPI.git
```

2. Prepare the genomic data

- Download the genomic features from [Synapse:syn26156164](https://www.synapse.org/#!Synapse:syn26156164) 
- edit the feature configuration file `./data/genomic_data/CTCF_DNase_6histone.500.json` to specifiy the locations of the genomic feature files downloaded from Synapse. *Absolute path is required!*  

3. Prepare input files

The input to the TransEPI model should be formatted as:

	1. label: for datasets without known labels, set it to 0
	2. distance: the between the enhancer and the promoter
	3. e_chr: enhancer chromosome
	4. e_start: enhancer start
	5. e_end: enhancer end
	6. enhancer name: the name of the cell type should be placed in the second field of enhancer name: e.g.: chr5:317258-317610|GM12878|EH37E0762690. (shoule be separated by `|`)
	7. p_chr: promoter chromosome
	8. p_start: promoter start
	9. p_end: promoter end
	10. promoter name: the name of the cell type should be placed in the second field of promoter name: e.g.: chr5:317258-317610|GM12878|EH37E0762690. (shoule be separated by `|`)
	11. mask region (optional): the feature values in the mask regions will be masked (set to 0). e.g.: 889314-895314;317258-327258

The input files should be tab separated

Example:
```
1	572380.0	chr5	317258	317610	chr5:317258-317610|GM12878|EH37E0762690	chr5	889314	891314	chr5:889813-889814|GM12878|ENSG00000028310.13|ENST00000388890.4|-
0	100101.0	chr5	317258	317610	chr5:317258-317610|GM12878|EH37E0762690	chr5	216833	218833	chr5:217332-217333|GM12878|ENSG00000164366.3|ENST00000441693.2|-
```

4. Run the model
```
cd TransEPI/src
chmod +x ./evaluate_
python ./evaluate_model.py \
	-t ../data/BENGI/HMEC.HiC-Benchmark.v3.tsv.gz \
	-c ../models/TransEPI_EPI.json \
	-m ../models/TransEPI_EPI_fold0.pt \
	-p output
```

# Step-by-step guide for custom usage

## Preparing genomic data
1. Download the genomic data required by TransEPI
	- CTCF ChIP-seq data in narrowPeak format
	- DNase-seq data in bigWig format
	- H3K27me3, H3K36me3, H3K4me1, H3K4me3, and H3K9me3 ChIP-seq data in bigWig format

2. Edit `TransEPI/data/genomic_data/bed/CTCF_bed.json` and `TransEPI/data/genomic_data/bigwig/bw_6histone.json` to specify the location of the narrowPeak and bigWig files

3. Convert narrowPeak and bigWig signals to `.pt` files
```
cd TransEPI/data/genomic_data
bash ./pipeline.sh
```
4. Add the `.pt` files generated by step 3 to `TransEPI/data/genomic_data/CTCF_DNase_6histone.500.json` 

**Summary**
- The location of raw narrowPeak and bigwig files should be specified in `TransEPI/data/genomic_data/bed/CTCF_bed.json` and `TransEPI/data/genomic_data/bigwig/bw_6histone.json`. 
- The processed data files should be specified in `TransEPI/data/genomic_data/CTCF_DNase_6histone.500.json`

## Preparing the configuration file for training model
The configuration file should be in `.json` format:
```
{
    "data_opts": {							// dataset configuration
        "datasets": [ 						// The "datasets" item is only used by cross_validate.py
            "../data/BENGI/GM12878.CTCF-ChIAPET-Benchmark.v3.tsv",
            "../data/BENGI/GM12878.HiC-Benchmark.v3.tsv",
            "../data/BENGI/GM12878.RNAPII-ChIAPET-Benchmark.v3.tsv",
            "../data/BENGI/HeLa.CTCF-ChIAPET-Benchmark.v3.tsv",
            "../data/BENGI/HeLa.HiC-Benchmark.v3.tsv",
            "../data/BENGI/HeLa.RNAPII-ChIAPET-Benchmark.v3.tsv"
        ],
        "feats_order": ["CTCF", "DNase", "H3K4me1", "H3K4me3", "H3K36me3", "H3K9me3",  "H3K27me3"], //  the order of features (do not change the order if you run the models provided by us)
        "feats_config": "../data/genomic_data/CTCF_DNase_6histone.500.json", // the configuration file of genomic features
        "bin_size": 500,					// bin sise used by TransEPI
        "seq_len": 2500000					// the size of large genomic context
    },

    "model_opts": {						// model configuration
        "model": "TransEPI",
        "cnn_channels": [180],
        "cnn_sizes": [11],
        "cnn_pool": [10],
        "enc_layers": 3,
        "num_heads": 6,
        "d_inner": 256,
        "da": 64,
        "r": 32,
        "att_C": 0.1,
        "fc": [128, 64],
        "fc_dropout": 0.2
    },

    "train_opts": {						//model training configuration
        "learning_rate": 0.0001,
        "batch_size": 128,
        "num_epoch": 300,
        "patience": 10,
        "num_workers": 16,
        "use_scheduler": false
    }
}
```
**Note**: the comments after `//` are used to describe the meaning of the items in json file. They should be removed because the json format does not support comments



# Models

The trained models are available at [models](./models).  


# Reproducibility

To reproduce the major results shown in the manuscripts, see [dev/run_cv.sh](./dev/run_cv.sh) (cross validation) and [dev/run_pred.sh](./dev/run_pred.sh) (evaluation).


# Baseline models and features   

- TargetFinder: [comparison/TargetFinder](./comparison/TargetFinder)   
- 3DPredictor: [comparison/3DPredictor](./comparison/3DPredictor)  


# Questions
For questions about the datasets and code, please contact [chenkenbio@gmail.com](mailto:chenkenbio@gmail.com) or create an issue.

# Citation

```
@article {Chen2021.09.04.458817,
	author = {Chen, Ken and Zhao, Huiying and Yang, Yuedong},
	title = {Capturing large genomic contexts for accurately predicting enhancer-promoter interactions},
	elocation-id = {2021.09.04.458817},
	year = {2021},
	doi = {10.1101/2021.09.04.458817},
	publisher = {Cold Spring Harbor Laboratory},
	URL = {https://www.biorxiv.org/content/early/2021/09/06/2021.09.04.458817},
	eprint = {https://www.biorxiv.org/content/early/2021/09/06/2021.09.04.458817.full.pdf},
	journal = {bioRxiv}
}
```
